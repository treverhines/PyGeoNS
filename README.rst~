PyGeoNS (Python-based Geodetic Network Strain software)
+++++++++++++++++++++++++++++++++++++++++++++++++++++++

What PyGeoNS can do
===================
PyGeoNS (pronounced like the bird) is a suite of command line 
executables that are used to smooth and differentiate geodetic GPS 
data in both space and time.  This analysis is performed in a Bayesian 
framework, using Gaussian process regression, and thus the 
uncertainties on the data products are well-quantified and meaningful. 
This software is primarily intended for estimating time dependent 
strain rates from GPS networks with tens to hundreds of stations.

What PyGeoNS does not do
========================
The core processing algorithms used by PyGeoNS come from the RBF 
python package, which can be found `here 
<http://www.github.com/treverhines/RBF>`_. PyGeoNS mostly does the 
requisit data munging, and it provides functions to interactively view 
and clean the data. There are several assumptions that have been hard 
coded into PyGeoNS which may make this software inapplicable to your 
project. In particular, if the Earth's curvature is non-negligible in 
your study region, then the map projection used by PyGeoNS 
(transverse-mercator) would not be appropriate. Additionally, PyGeoNS 
is designed to handle data with daily sampling rates. Less frequent 
sampling rates can be handled, such as for campaign GPS, but PyGeoNS 
cannot use data that has been sampled at higher frequencies. If these 
limitations conflict with your project needs, then it may be better to 
directly interface with the RBF package. Finally, the plotting 
functions in PyGeoNS are intended to be a convenient way of 
interactively viewing GPS data, but they are not intended to be 
customizable to meet everyones plotting needs. 

Installation
============
PyGeoNS requires the standard scientific python packages, which can be 
found in the base Anaconda python installation 
(http://www.continuum.io/downloads). Additionally, PyGeoNS requires 
that the RBF package be installed 
(http://www.github.com/treverhines/RBF). Once these dependencies are 
satisfied, this package can be downloaded and installed with the 
following commands

.. code-block:: bash

  $ git clone http://www.github.com/treverhines/PyGeoNS.git
  $ cd PyGeoNS 
  $ python setupy.py install

Executables
===========
PyGeoNS contains the following command line executable functions. Call 
these functions with a '-h' flag to see more information.

* ``pygeons-toh5`` : Converts data from a text file to an hdf5 file.
* ``pygeons-totext`` : Converts data from a hdf5 file to a csv file.
* ``pygeons-info`` : Prints metadata from a data file to stdout.
* ``pygeons-view`` : Starts an interactive map view and time series 
  view of vector data sets (e.g. displacements, deformation gradients, 
  etc.).
* ``pygeons-strain`` : Starts an interactive map view and time series 
  view of strain. 
* ``pygeons-clean`` : Starts the interactive cleaner, which is used to 
  manually remove jumps and outliers.
* ``pygeons-crop`` : Bounds the spatial and temporal extent of the data 
  set.
* ``pygeons-tgpr`` : Temporally smooths and differentiates a data set.
* ``pygeons-sgpr`` : Spatially smooths and differentiates a data set.

Text Data Format
================
PyGeoNS is currently able to read three text file formats: PBO csv 
files, PBO pos files, and a csv file format designed for PyGeoNS. See 
www.unavco.org for information on the PBO data file formats. An 
example of each file format is provided below.

PBO CSV
-------
.. code-block::

  PBO Station Position Time Series.
  Format Version, 1.2.0
  Reference Frame, NAM08
  4-character ID, P403
  Station name, FloeQuaryGWA2005
  Begin Date, 2005-09-13
  End Date, 2017-01-26
  Release Date, 2017-01-27
  Source file, P403.pbo.nam08.pos
  Offset from source file, 48.54 mm North, 60.55 mm East, -5.06 mm Vertical
  Reference position, 48.0623223017 North Latitude, -124.1408746693 East Longitude, 284.67725 meters elevation
  Date, North (mm), East (mm), Vertical (mm), North Std. Deviation (mm), East Std. Deviation (mm), Vertical Std. Deviation (mm), Quality,  
  2005-09-13,0.00, 0.00, 0.00, 4.71, 3.14, 13.2, repro,
  2005-09-14,7.43, 8.65, 2.37, 1.85, 1.34, 5.6, repro,
  ...
  2017-01-26,98.68, 132.58, 6.00, 1.93, 1.49, 6.34, rapid,

PBO POS
-------
.. code-block::

  PBO Station Position Time Series. Reference Frame : NAM08
  Format Version: 1.1.0
  4-character ID: P403
  Station name  : FloeQuaryGWA2005
  First Epoch   : 20050913 120000
  Last Epoch    : 20170126 120000
  Release Date  : 20170127 235743
  XYZ Reference position :  -2396874.51122 -3534734.44146  4721722.14918 (NAM08)
  NEU Reference position :    48.0623223017  235.8591253307  284.67725 (NAM08/WGS84)
  Start Field Description
  YYYYMMDD      Year, month, day for the given position epoch
  HHMMSS        Hour, minute, second for the given position epoch
  JJJJJ.JJJJJ   Modified Julian day for the given position epoch
  X             X coordinate, Specified Reference Frame, meters
  Y             Y coordinate, Specified Reference Frame, meters
  Z             Z coordinate, Specified Reference Frame, meters
  Sx            Standard deviation of the X position, meters
  Sy            Standard deviation of the Y position, meters
  Sz            Standard deviation of the Z position, meters
  Rxy           Correlation of the X and Y position
  Rxz           Correlation of the X and Z position
  Ryz           Correlation of the Y and Z position
  Nlat          North latitude, WGS-84 ellipsoid, decimal degrees
  Elong         East longitude, WGS-84 ellipsoid, decimal degrees
  Height (Up)   Height relative to WGS-84 ellipsoid, m
  dN            Difference in North component from NEU reference position, meters
  dE            Difference in East component from NEU reference position, meters
  du            Difference in vertical component from NEU reference position, meters
  Sn            Standard deviation of dN, meters
  Se            Standard deviation of dE, meters
  Su            Standard deviation of dU, meters
  Rne           Correlation of dN and dE
  Rnu           Correlation of dN and dU
  Reu           Correlation of dEand dU
  Soln          "rapid", "final", "suppl/suppf", "campd", or "repro" corresponding to products  generated with rapid or final orbit products, in supplemental processing, campaign data processing or reprocessing
  End Field Description
  *YYYYMMDD HHMMSS JJJJJ.JJJJ         X             Y             Z            Sx        Sy       Sz     Rxy   Rxz    Ryz            NLat         Elong         Height         dN        dE        dU         Sn       Se       Su      Rne    Rnu    Reu  Soln
   20050913 120000 53626.5000 -2396874.58357 -3534734.44007  4721722.12054  0.00645  0.00812  0.00994  0.811 -0.686 -0.775      48.0623218656  235.8591245168  284.68231    -0.04854  -0.06055   0.00506    0.00471  0.00314  0.01320  0.163 -0.115 -0.095 repro
   20050914 120000 53627.5000 -2396874.57419 -3534734.44167  4721722.12726  0.00261  0.00353  0.00416  0.793 -0.733 -0.788      48.0623219323  235.8591246330  284.68468    -0.04111  -0.05190   0.00743    0.00185  0.00134  0.00560 -0.002 -0.141 -0.016 repro
   ...
   20170126 120000 57779.5000 -2396874.43473 -3534734.45725  4721722.19088  0.00295  0.00382  0.00479  0.797 -0.776 -0.801      48.0623227520  235.8591262989  284.68831     0.05014   0.07203   0.01106    0.00193  0.00149  0.00634 -0.045 -0.073 -0.110 rapid

PyGeoNS CSV
-----------
The PyGeoNS CSV file only contains information that PyGeoNS uses, 
making it unambigous which fields can influence the results. For 
example, there is no reference frame information in the PyGeoNS csv 
format because PyGeoNS does not ever use that information.

.. code-block::

  4-character id, P403
  begin date, 2005-09-13
  end date, 2017-01-26
  longitude, 235.859125331 E
  latitude, 48.0623223017 N
  units, meters**1 days**0
  date, north, east, vertical, north std. deviation, east std. deviation, vertical std. deviation
  2005-09-13, -4.854000e-02, -6.055000e-02, 5.060000e-03, 4.710000e-03, 3.140000e-03, 1.320000e-02
  2005-09-14, -4.111000e-02, -5.190000e-02, 7.430000e-03, 1.850000e-03, 1.340000e-03, 5.600000e-03
  ...
  2017-01-26, 5.014000e-02, 7.203000e-02, 1.106000e-02, 1.930000e-03, 1.490000e-03, 6.340000e-03

HDF5 Data Format
================
To cut out overhead associated with reading and writing, most PyGeoNS
executables read from and write to HDF5 files. Any of the above text 
file formats can be converted to an HDF5 file by doing the following. 
First, concatenate the data files for each station into one file 
separated by ``***``. For example, if the data files are in the 
current directory and contain a ``.csv`` extension then they can be 
concatenated with the following sed incantation

.. code-block::

  $ sed -s '$a***' *.csv | sed '$d' > data.csv 

Second, convert the new text file to an HDF5 file with the PyGeoNS 
command ``pygeons-toh5`` and use the ``--file_type`` flag followed by 
either ``csv``, ``pbocsv``, or ``pbopos``. By default, this is set to 
``csv``, indicating the file is a PyGeoNS csv file. Once you have 
converted the data to an HDF5 file, it can be passed as an argument to 
the remaining PyGeoNS executables for analysis and processing. An HDF5 
file can be converted back to a PyGeoNS csv file using 
``pygeons-totext`` followed by the file name.

An HDF5 file can be read using, for example, the h5py package in 
python. Each HDF5 file contain the following entries

* ``time`` : Array of unique integers with shape (Nt,). Integer values 
  of modified Julian dates.
* ``id`` : Array of unique strings with shape (Nx,). 4-character IDs 
  for each station.
* ``longitude``, ``latitude`` : Array of floats with shape (Nx,). 
  Coordinates for each station.
* ``east``, ``north``, ``vertical`` : Array of floats with shape 
  (Nt,Nx). These are the data components. The units should be in terms 
  of meters and days and should be consistent with the values 
  specified for ``space_exponent`` and ``time_exponent``. For example, 
  if ``time_exponent`` is -1 and ``space_exponent`` is 1 then the units 
  should be in meters per day. If data is missing for a particular 
  time and station then it should be set to nan.
* ``east_std_dev``, ``north_std_dev``, ``vertical_std_dev`` : Array of 
  floats with shape (Nt,Nx). One standard deviation uncertainties for 
  each component of the data.  The units should be the same as those 
  used for the data components. If data is missing for a particular 
  time and station then it should be set to inf.
* ``time_exponent`` : Integer. This indicates the power of the time 
  units for the data. -1 indicates that the data is a rate, -2 indicates 
  an acceleration, etc.
* ``space_exponent`` : Integer. Indicates the power of the spatial 
  units for the data.
  
Demonstration
=============
See the scripts named ``run.sh`` in the ``demo`` directory for 
examples of how to use PyGeoNS. The below commands run through the 
script ``demo/demo4/run.sh``. In this demonstration we will be looking 
for elevated strain rates resulting from slow slip events in the 
Cascadia subduction zone. The stations we will use are all located on 
or near the Olympic Peninsula in Washington.

We begin by downloading GPS data from UNAVCO's FTP repository. We have 
the URLs for the station files saved in ``urls.txt``. Below are the contents of 
``urls.txt``

.. code-block::

  ftp://data-out.unavco.org/pub/products/position/TWHL/TWHL.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/SEDR/SEDR.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/SEAT/SEAT.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/SC03/SC03.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/SC02/SC02.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/PCOL/PCOL.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/PABH/PABH.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P816/P816.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P815/P815.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P439/P439.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P438/P438.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P437/P437.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P436/P436.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P435/P435.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P426/P426.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P424/P424.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P423/P423.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P419/P419.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P418/P418.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P403/P403.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P402/P402.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P401/P401.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P400/P400.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P399/P399.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/P064/P064.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/NEAH/NEAH.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/KTBW/KTBW.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/BLYN/BLYN.pbo.nam08.csv
  ftp://data-out.unavco.org/pub/products/position/ALBH/ALBH.pbo.nam08.csv

We use ``wget`` and ``sed`` to download the station files and merge 
them into a single csv file.

.. code-block::

  $ mkdir -p work/csv
  $ for i in `cat urls.txt`; do wget -P work/csv $i; done 
  $ sed -s '$a***' work/csv/* | sed '$d' > work/data.csv

The csv file ``work/data.csv`` is then converted to an HDF5 data file 
and temporally cropped to keep this demonstration computationally 
light-weight.

.. code-block::

  $ pygeons-toh5 work/data.csv \
                 --file_type pbocsv \
                 --output_file work/data.h5
  $ pygeons-crop work/data.h5 \
                 --start_date 2015-01-01 \
                 --stop_date 2017-01-01 \
                 --output_file work/data.h5

Metadata for the newly created data file can be viewed with the 
following command

.. code-block::
  
  $ pygeons-info work/data.h5

  units : meters**1 days**0
  stations : 29
  times : 732
  time range : 2015-01-01, 2017-01-01
  longitude range : -124.624907154, -122.223847947
  latitude range : 47.0159055879, 48.7081927394
  station names : ALBH, BLYN, KTBW, NEAH, P064, P399, P400, P401, P402, P403, P418, P419, P423, P424, P426, P435, P436, P437, P438, P439, P815, P816, PABH, PCOL, SC02, SC03, SEAT, SEDR, TWHL

The data set can be interactively viewed with the command

.. code-block::
  
  $ pygeons-view work/data.h5
  
This will open up two interactive figures. Use the left/right arrow 
keys to scroll through time and the up/down arrow keys to scroll 
through stations. More instructions will be printed to the screen when 
the interactive figures are displayed.

PyGeoNS is primarily intended for calculating strain rates from GPS 
displacement time series. This is done in two steps. First, the 
displacements are temporally smoothed and differentiated with 
``pygeons-tgpr``. Then the resulting velocities are spatially smoothed 
and differentiated with ``pygeons-sgpr`` to get the deformation 
gradients. Viewing the strain rates is done by calling 
``pygeons-strain``. The below code blocks demonstrate this process 
using the dataset created above. 

We specify a prior for the underlying signal which we are trying to 
recover. That signal is the deformation resulting from slow slip 
events. We assume that slow slip events have a characteristic 
time-scale of 0.05 years, and the standard deviation of the signals 
amplitude is 10 mm (which is roughly the magnitude of observed 
displacements resulting from slow slip events). Temporal smoothing is 
then done by

.. code-block:: 
  
  $ pygeons-tgpr work/data.h5 10.0 0.05 \
                 --output_file work/smooth.h5 -vv

We can compare the observed and smoothed data to make sure that our 
prior was not too restrictive with the following command

.. code-block::
  
  $ pygeons-view work/data.h5 work/smooth.h5

To calculate velocities we call ``pygeons-tgpr`` again but with the 
``diff`` argument

.. code-block::
  
  $ pygeons-tgpr work/data.h5 10.0 0.05 \
                 --diff 1 \
                 --output_file work/velocity.h5 -vv

We then spatially smooth and differentiate the velocities. We assume 
that surface velocities resulting from slow slip events have a 
characteristic length-scale of 150 km, and the standard deviation of 
the signals amplitude is 100 mm/yr (which is roughly the magnitude of 
velocities resulting from slow slip events). We spatially 
differentiate the velocities along the east (x) and north (y) 
direction with two commands.

.. code-block::
  
  $ pygeons-sgpr work/velocity.h5 100.0 150.0 \
                 --diff 1 0 \
                 --output_file work/xdiff.h5 -vv
  $ pygeons-sgpr work/velocity.h5 100.0 150.0 \
                 --diff 0 1 \
                 --output_file work/ydiff.h5 -vv

We now have two HDF5 data files which contain the deformation 
gradients. We can interactively view the strain rates with the command

.. code-block::

  $ pygeons-strain work/xdiff.h5 work/ydiff.h5 \
                   --scale 1e4 \
                   --key_magnitude 1.0 \
                   --key_position 0.1 0.9

Which will produce the following figures

.. figure:: demo/demo4/figures/map_view.png

  Map view of strain rates during a slow slip event. The glyphs show 
  the normal strain rates along each azimuth, where red indicates 
  compression and blue indicates extension. The shaded region 
  indicates the 68% confidence interval in the normal strain rates. 

.. figure:: demo/demo4/figures/time_series.png

  Time series of each component of the strain rate tensor at the 
  station indicated by the black dot. The shaded region indicates the 
  68% confidence interval. The jaggedness in the solution is a result 
  of the outlier detection algorithm. When the outlier detection 
  algorithm flags a station for having anomalously high velocities, 
  that station is not used to calculate the deformation gradient. As a 
  result, the deformation gradient has small jumps whenever a station 
  is flagged.
  
  which causes station with anomalously high 
  velocities to be ignored when computing the deformation gradients.from some detected outlier being

Lastly, if you would prefer a human-readable format for the 
deformation gradients, the HDF5 files can be converted to text files by

.. code-block::

  $ pygeons-totext work/xdiff.h5 
  $ pygeons-totext work/ydiff.h5 
